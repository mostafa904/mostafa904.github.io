---
title: "Server Side Templete Injection"
tags:
    - WEB
    - ssti
date: "2024-08-6"
thumbnail: "/assets/img/thumbnail/ssti.jpg"
bookmark: true
---
# Description
---
some web application use template to enable dynamic content generation in pages 

Attacker is able to use native template syntax to inject a malicious payload into a template, which is then executed server-side.

attacks depending on the template engine in question and how exactly the application uses it.

# impact
---
- remote code execution,
- taking full control of the back-end server
- read access to sensitive data and arbitrary files on the server.
---

**Not vulnerable to server-side template injection:**

because the user's first name is merely passed into the template as data.
```python
 $output = $twig->render("Dear {first_name},", array("first_name" => $user.first_name) );
```
**Vulnerable to server-side template injection:**
```python
`$output = $twig->render("Dear " . $_GET['name']);`
```
**Server-side template injection attack**

<img src="/assets/img/ssti/1.png">
<img src="/assets/img/csrf/2.png">

For example, the payload `{{7*'7'}}`returns `49`in Twig and `7777777` in Jinja2

**Basic template syntax**
```python
<%
                import os
                x=os.popen('id').read()
                %>
                ${x}
```
**To get Template type:**

1- make error to get it like abuse syntax

2- trying 

{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}

**Tools**

1- The basic syntax for tplmap is different depending on whether you're using get or post

| GET | tplmap -u <url>/?<vulnparam> |
| --- | --- |
| POST| tplmap -u <url> -d '<vulnparam>' |
```bash
./tplmap.py -u http://0.0.0.0:5000/ -d ‘name’
./tplmap.py -u http://0.0.0.0:5000/ -d ‘name’ --os-cmd “id”
```
**Explore**

Many template engines expose a "`self`" or "`environment`" object of some kind, which acts like a namespace containing all objects, methods, and attributes that are supported by the template engine.

Some objects because they are especially likely to contain sensitive information or exploitable methods.

For example, in Java-based templating languages, you can sometimes 
list all variables in the environment using the following injection:

```java
${T(java.lang.System).getenv()}
```

**Exploit using an object chain (way to bypass sandbox)**

Chaining together the right objects and methods sometimes allows you to gain access to dangerous functionality and sensitive data that initially appears out of reach.

For example, in the Java-based template engine Velocity, you have access to a `ClassTool` object called `$class`. Studying the documentation reveals that you can chain the `$class.inspect()` method and `$class.type`property to obtain references to arbitrary objects. In the past, this 
has been exploited to execute shell commands on the target system as 
follows:

```java
$class.inspect("java.lang.Runtime").type.getRuntime().exec("bad-stuff-here")
```
# Mitigation

never allow users to modify or create templates.

use of regex, white lists of authorised expressions.

Sandboxing that creates a safe, isolated environment for users. but sandbox environments are difficult to set up and can be bypassed by misconfiguration or oversights.
---

