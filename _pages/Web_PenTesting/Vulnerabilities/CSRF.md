---
title: "Cross-Site Request Forgery"
tags:
    - CSRF
    - WEB
    - PHP
date: "2024-07-23"
thumbnail: "/assets/img/thumbnail/csrf.png"
bookmark: true
---

# Description
---

Cross-Site Request Forgery (CSRF) is a type of attack that tricks a victim into submitting a malicious request. It exploits the trust that a web application has in an authenticated user. CSRF attacks specifically target state-changing requests, not theft of data, because the attacker cannot see the response to the forged request.
How CSRF Works

    Victim Logs In: The user logs into a website (e.g., a banking site) and their session is authenticated.
    Malicious Website: The user then visits another website controlled by the attacker.
    Malicious Request: This website contains malicious code that causes the user's browser to make an unwanted request to the banking site. Since the user is already authenticated, the request is accepted.

# CSRF Attack Example

Consider a vulnerable banking application that allows users to transfer money:
Vulnerable HTML Form:
```html
<form action="transfer.php" method="post">
    <input type="text" name="amount" placeholder="Amount">
    <input type="text" name="to_account" placeholder="Recipient Account">
    <input type="submit" value="Transfer">
</form>
```
Vulnerable PHP Code:
```php
<?php
session_start();

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $amount = $_POST['amount'];
    $to_account = $_POST['to_account'];
    $from_account = $_SESSION['user_account'];

    transfer_money($from_account, $to_account, $amount);
    echo "Transfer successful!";
}
function transfer_money($from, $to, $amount) {
}
?>
```
Malicious HTML Form:
The attacker creates a page that auto-submits a form to the banking site:
```html
<form action="http://bankingsite.com/transfer.php" method="post">
    <input type="hidden" name="amount" value="1000">
    <input type="hidden" name="to_account" value="attacker_account">
    <input type="submit" value="Transfer">
</form>

<script>
    document.forms[0].submit(); // Automatically submits the form
</script>
```
When the user, who is logged into their banking account, visits the attacker's page, the form is submitted to the banking site without their knowledge, transferring money to the attacker's account.

# Preventing CSRF
The best way to prevent CSRF attacks is to include a CSRF token in each form and validate this token on the server side.
Step 1: Generate and Store CSRF Token

Generate a CSRF token when the user's session is created and store it in the session:
```php
session_start();

if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
```
Step 2: Include CSRF Token in Forms
Embed the CSRF token in all forms that change state (e.g., POST requests):
```html
<form action="transfer.php" method="post">
    <input type="text" name="amount" placeholder="Amount">
    <input type="text" name="to_account" placeholder="Recipient Account">
    <input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">
    <input type="submit" value="Transfer">
</form>
```
Step 3: Validate CSRF Token
Check the token on the server before processing the request:
```php
<?php
session_start();

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die('CSRF token validation failed');
    }

    $amount = $_POST['amount'];
    $to_account = $_POST['to_account'];
    $from_account = $_SESSION['user_account'];

    transfer_money($from_account, $to_account, $amount);

    echo "Transfer successful!";
}
function transfer_money($from, $to, $amount) {
}
?>
```
Advanced CSRF Prevention Techniques

    SameSite Cookies: Configure cookies with the SameSite attribute to prevent them from being sent along with cross-site requests.
```php
setcookie('session', $session_id, [
    'samesite' => 'Strict',
    'secure' => true,
    'httponly' => true
]);
```
Double Submit Cookies: Send the CSRF token in both a cookie and a request parameter, then validate that both match.

Generating Token:
```php
session_start();
$csrf_token = bin2hex(random_bytes(32));
setcookie('csrf_token', $csrf_token, [
    'samesite' => 'Strict',
    'secure' => true,
    'httponly' => true
]);
$_SESSION['csrf_token'] = $csrf_token;
```
Including Token in Form:
```html
<form action="transfer.php" method="post">
    <input type="text" name="amount" placeholder="Amount">
    <input type="text" name="to_account" placeholder="Recipient Account">
    <input type="hidden" name="csrf_token" value="<?php echo $csrf_token; ?>">
    <input type="submit" value="Transfer">
</form>
```
Validating Token:
```php
    <?php
    session_start();
    if ($_SERVER['REQUEST_METHOD'] == 'POST') {
        if (!isset($_POST['csrf_token']) || !isset($_COOKIE['csrf_token']) || $_POST['csrf_token'] !== $_COOKIE['csrf_token']) {
            die('CSRF token validation failed');
        }
        $amount = $_POST['amount'];
        $to_account = $_POST['to_account'];
        $from_account = $_SESSION['user_account'];

        transfer_money($from_account, $to_account, $amount);

        echo "Transfer successful!";
    }
    function transfer_money($from, $to, $amount) {
    }
    ?>
```
By implementing these measures, you can protect your PHP applications from CSRF attacks and ensure that only legitimate requests are processed.